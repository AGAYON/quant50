name: Weekly Training

on:
  schedule:
    # Run at 00:00 UTC on Sunday
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  weekly-train:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Weekly Training
        env:
          ALPACA_API_KEY_ID: ${{ secrets.ALPACA_API_KEY_ID }}
          ALPACA_API_SECRET_KEY: ${{ secrets.ALPACA_API_SECRET_KEY }}
          REPORTS_DIR: data/reports
          DUCKDB_PATH: data/market.duckdb
        run: |
          python jobs/weekly_train.py

      - name: Create Release
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME=weekly-$(date +'%Y-%m-%d')
          # Ensure tag doesn't exist or handle error? 
          # For simplicity, we assume unique run per day or overwrite if needed (requires delete).
          # We'll just try to create it.
          gh release create $TAG_NAME \
            --title "Weekly Snapshot $TAG_NAME" \
            --notes "Automated weekly snapshot and model training." \
            data/market_snapshot.parquet \
            models/latest_model.pkl \
            models/scaler.pkl \
            models/model_meta.json || echo "Release $TAG_NAME might already exist"

      - name: Push to Model Registry
        if: success()
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Stash artifacts to a temp dir
          mkdir -p /tmp/artifacts
          cp models/* /tmp/artifacts/
          
          # Switch to orphan branch
          git checkout --orphan model-registry
          git rm -rf .
          
          # Copy artifacts back
          cp /tmp/artifacts/* .
          
          git add .
          git commit -m "Update model registry $(date +'%Y-%m-%d')"
          git push origin model-registry --force
